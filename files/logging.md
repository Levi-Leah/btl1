# Logging and Aggregation

* Logs are detailed lists of application information, system performance statistics, or user activities
* useful for keeping track of computer use, network activity, security issues, and error reports
* it’s important to define exactly what logs are needed. In large organizations, the volume of data passed to a SIEM can be absolutely huge, so we need to work out what logs we actually need, and what devices we need logs from
* scoping this appropriately means there is less noise, and it’s easier to analyze the data we actually need, instead of the data we have access to

---

* **Syslog**
  * System Logging Protocol (Syslog) is a standard protocol used to convey event or system log notification messages to a designated server, known as a Syslog server
  * Syslog server centralizes data collection from various devices for analysis, review, and intervention
  * Syslog protocol is outlined by [RFC 5424](https://datatracker.ietf.org/doc/html/rfc5424)
  * can be enabled on most network equipment such as switches, routers and firewalls, and even endpoint devices
  * available on Unix and Linux-based systems and many web servers
  * Windows systems use their own by default as opposed to Syslog (Windows Event Manager)
    * can also be forwarded to a central server, via third-party utilities or other configurations using the Syslog protocol
  * custom apps can also be developed to use Syslog for log transport
  * Syslog uses UDP 514 by default; TCP 514 can be used for more reliability
    * security standards require that logs are securely transferred, so TCP 6514 is used as a de facto standard
  * Syslog does not offer authentication or encryption built-in, so it may be susceptible to attacks
  * **Syslog Messages**
    * Syslog message is made of three components:
      * **Priority Value (PRI)**
        * derived from both the Facility Code and the Severity Level
          * `PRI = (Facility × 8) + Severity`

          | Number  | Facility Description                    |
          |---------|-----------------------------------------|
          | 0       | Kernel messages                        |
          | 1       | User-level messages                    |
          | 2       | Mail System                            |
          | 3       | System Daemons                         |
          | 4       | Security/Authorization Messages        |
          | 5       | Messages generated by syslog           |
          | 6       | Line Printer Subsystem                 |
          | 7       | Network News Subsystem                 |
          | 8       | UUCP Subsystem                         |
          | 9       | Clock Daemon                           |
          | 10      | Security/Authorization Messages        |
          | 11      | FTP Daemon                             |
          | 12      | NTP Subsystem                          |
          | 13      | Log Audit                              |
          | 14      | Log Alert                              |
          | 15      | Clock Daemon                           |
          | 16 - 23 | Local Use 0 - 7                        |

          | Value | Severity      | Keyword   | Description                                | Condition                                                |
          |-------|---------------|-----------|--------------------------------------------|----------------------------------------------------------|
          | 0     | Emergency     | emerg     | System is unusable                         | A panic condition.                                       |
          | 1     | Alert         | alert     | Action must be taken immediately           | A condition that should be corrected immediately, such as a corrupted system database. |
          | 2     | Critical      | crit      | Critical conditions                        | Hard device errors.                                      |
          | 3     | Error         | err       | Error conditions                           |                                                          |
          | 4     | Warning       | warning   | Warning conditions                         |                                                          |
          | 5     | Notice        | notice    | Normal but significant conditions          | Conditions that are not error conditions, but that may require special handling. |
          | 6     | Informational | info      | Informational messages                     |                                                          |
          | 7     | Debug         | debug     | Debug-level messages                       | Messages that contain information normally of use only when debugging a program. |

      * **Header**
        * contains Timestamp, Hostname, Application name, Message ID
      * **Message**
        * could be simple readable text or only machine-readable
        * content of the message is not defined by the protocol only the format is
        * each message sent to the Syslog server has two labels associated with it:
          * The first label describes the function (facility) of the application that generated it
            * e.g., mail servers typically log using the mail facility
          * The second label specifies the severity level 
        * After these two labels, the action is specified
          * usually a filename in the `/var/log` directory tree, in which the messages will be stored

---

* **Windows Event Logs**
  * Windows Event logs or Event Logs are `.evtx` files in binary format stored locally in the Windows directory
    * Windows 2000 to WinXP/Windows Server 2003
      * `%WinDir%\system32\Config*.evt`
    * Windows Server 2008 to 2019, and Windows Vista to Win10:
      * `%WinDir%\system32\WinEVT\Logs*.evtx`
  * keep a detailed record of the vast majority of events that have occurred on the system
    * hardware events, user logins, program execution and installation, etc.
  * Categories of registered events include:
    * Application
      * Events logged by an application
        * Execution, Deployment error, etc.
    * System: Events logged by the Operating System
      * Device loading, startup errors, etc.
    * Security
      * Events that are relevant to the security of the system
        * Logins and logouts, file deletion, granting of administration permissions, etc.
    * Directory Service
      * a record available only to Domain Controllers, it stores Active Directory (AD) events
    * DNS Server
      * a record available only to DNS servers; logs of DNS service are stored
    * File Replication Service
      * a record available only for Domain Controllers, it stores Domain Controller Replication events
    * [Monitoring Windows Event Logs - A Tutorial (article)](https://www.manageengine.com/eu/network-monitoring/Eventlog_Tutorial_Part_I.html)

---

* **Windows Security Event Logs**
  * events stored by the system that contain information related to the “Windows Security audit policies”
    * Some of these elements are:
      * Account logon events
        * valid and invalid sign-ons and sign-offs
      * Account management
        * creation, modification, interaction and deletion of user accounts
      * Privilege use
      * Resource usage
        * file creation, modification, interaction and deletion
  * [Windows Security audit (article)](https://docs.nxlog.co/integrate/windows-security-audit.html)
  * [Windows Security Event Logs - cheatsheet](https://andreafortuna.org//2019/06/12/windows-security-event-logs-my-own-cheatsheet/)
  * [Windows Security Log Events - list](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/default.aspx)

---

* **Event Viewer**
  * program to view all different types of logs
* **Custom Views**
  * Event Viewer allows us to create custom search profiles, called “Custom Views”
  * use these to retrieve the event IDs we want from a system, removing all of the extra noise that we’re not interested in
  * can be useful if a system is not connected to a SIEM, allowing us to retrieve specific event logs

---

* **Sysmon**
  * a Windows system service and device driver that, once installed on a system, remains resident across system reboots to monitor and log system activity to the Windows event log
  * provides detailed information about process creations, network connections, and changes to file creation time
  * Pros
    * Logs process creation with full command line for both current and parent processes
    * Include a session GUID in each event to allow correlation of events on the same logon session
    * Logs loading of drivers or DLLs with their signatures and hashes
    * Optionally logs network connections, including each connection’s source process, IP addresses, port numbers, hostnames, and port names
    * Detects changes in file creation time to understand when a file was really created
      * Modification of file create timestamps is a technique commonly used by malware to cover its tracks
    * Rule filtering to include or exclude certain events dynamically
    * Installation
      * Download Sysmon zip from the Sysinternals website
      * Once you’ve extracted the folder within the Zip file, open a command prompt as administrator and move to the location of the executable files
      * Use `sysmon -i` to begin the install, and click Agree when the EULA pops up
      * Event Viewer > Custom View > Choose Sysmon as source and check all event levels

---

* **Windows Event Logs vs Sysmon Logs**
  * win event logs suck balls so people created sysmon
  * there’s just a ton more useful information compared to Windows event logs
  * [Implementing Sysmon and Applocker - YouTube video](https://www.youtube.com/watch?t=491.&v=9qsP5h033Qk&feature=youtu.be)
  * The problem with Sysmon is that it’s very broad, and can generate a lot of noise
  * To combat this, we can use Sysmon configuration files
    * [example config file](https://github.com/SwiftOnSecurity/sysmon-config)

---

* **Microsoft Azure logs**
  * Logs in Azure, are primarily monitored through Azure Monitor and Log Analytic Workspaces
  * Azure Monitor is able to pick up logs from a multitude of different Azure services such as, virtual machines, virtual networks, Azure Active Directory, and Azure Security Center, as well as on-premises services
  * Azure has three primary categories of logs
    * Control/Management logs
    * Data Plane logs
    * Processed Events
  * These logs are fed to Azure through the Azure REST API, the Microsoft Graph API, JSON, and various other sources
  * can be connected to different kinds of SIEMs such as Splunk or even Microsoft’s own Azure Sentinel.
  * When investigating logs in Azure, you will need to use the [Kusto Query Language (KQL)](https://learn.microsoft.com/en-us/kusto/query/?view=azure-data-explorer&preserve-view=true) to query logs
* **Amazon Web Services logs**
  * GUI offers an easy way to access and manage resources, Amazon uses their own API for AWS
  * [AWS Documentation](https://docs.aws.amazon.com/)
* **OSQuery**
  * by facebook
  * operating system instrumentation framework that exposes an operating system as a high-performance relational database
  * using SQL, you can write a single query to explore any given data, regardless of the operating system
  * surprisingly good idea
* **Moloch (Arkime)**
  * stores and indexes network traffic in PCAP format, providing fast access via a web interface or APIs for browsing, searching, and exporting
  * integrates with tools like Wireshark and scales across multiple systems to handle high traffic volumes

---

* **Log aggregation**
  * process of collecting logs from multiple computing systems, parsing them, extracting structured data, and putting them together in a format that is easily searchable and explorable by modern data tools
  * 4 common ways to aggregate logs; many log aggregation systems combine multiple methods
    * **Syslog**
      * NT admins can set up a Syslog server that receives logs from multiple systems, storing them in an efficient, condensed format that is easily queryable
      * Log aggregators can directly read and process Syslog data.
    * **Event stream**
      * Protocols like SNMP, Netflow, and IPFIX allow network devices to provide standard information about their operations, which can be intercepted by the log aggregator, parsed, and added to central log storage
    * **Log Collectors**
      * Software agents that run on network devices, capture log information, parse it and send it to a centralized aggregator component for storage and analysis
    * **Direct Access**
      * Log aggregators can directly access network devices or computing systems, using an API or network protocol to directly receive logs
      * requires custom integration for each data source
  * when pulled into a SIEM platform, there are 2 categories
    * **Structured data**
      * usually logs for Apache, IIS, Windows events, Cisco logs, and some other manufacturers
      * have clearly-defined fields (e.g., `src_ip`) and are similar to other structured logs
      * relatively easy to parse and normalize
    * **Unstructured data**
      * typically comes from a custom-built application where each message can be printed differently in different operations and the event itself can span multiple lines with no defined event start point, event endpoint, or both
      * likely to be the majority of the data being sent to the SIEM
    * to get all logs to follow a similar format to make it easier to perform searches across a large set of different logs, where possible, we can use normalization techniques