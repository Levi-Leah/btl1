# Logging and Aggregation

* Logs are detailed lists of application information, system performance statistics, or user activities
* useful for keeping track of computer use, network activity, security issues, and error reports
* it’s important to define exactly what logs are needed. In large organizations, the volume of data passed to a SIEM can be absolutely huge, so we need to work out what logs we actually need, and what devices we need logs from
* scoping this appropriately means there is less noise, and it’s easier to analyze the data we actually need, instead of the data we have access to

---

* **Syslog**
  * System Logging Protocol (Syslog) is a standard protocol used to convey event or system log notification messages to a designated server, known as a Syslog server
  * Syslog server centralizes data collection from various devices for analysis, review, and intervention
  * Syslog protocol is outlined by [RFC 5424](https://datatracker.ietf.org/doc/html/rfc5424)
  * can be enabled on most network equipment such as switches, routers and firewalls, and even endpoint devices
  * available on Unix and Linux-based systems and many web servers
  * Windows systems use their own by default as opposed to Syslog (Windows Event Manager)
    * can also be forwarded to a central server, via third-party utilities or other configurations using the Syslog protocol
  * custom apps can also be developed to use Syslog for log transport
  * Syslog uses UDP 514 by default; TCP 514 can be used for more reliability
    * security standards require that logs are securely transferred, so TCP 6514 is used as a de facto standard
  * Syslog does not offer authentication or encryption built-in, so it may be susceptible to attacks
  * **Syslog Messages**
    * Syslog message is made of three components:
      * **Priority Value (PRI)**
        * derived from both the Facility Code and the Severity Level
          * `PRI = (Facility × 8) + Severity`

          | Number  | Facility Description                    |
          |---------|-----------------------------------------|
          | 0       | Kernel messages                        |
          | 1       | User-level messages                    |
          | 2       | Mail System                            |
          | 3       | System Daemons                         |
          | 4       | Security/Authorization Messages        |
          | 5       | Messages generated by syslog           |
          | 6       | Line Printer Subsystem                 |
          | 7       | Network News Subsystem                 |
          | 8       | UUCP Subsystem                         |
          | 9       | Clock Daemon                           |
          | 10      | Security/Authorization Messages        |
          | 11      | FTP Daemon                             |
          | 12      | NTP Subsystem                          |
          | 13      | Log Audit                              |
          | 14      | Log Alert                              |
          | 15      | Clock Daemon                           |
          | 16 - 23 | Local Use 0 - 7                        |

          | Value | Severity      | Keyword   | Description                                | Condition                                                |
          |-------|---------------|-----------|--------------------------------------------|----------------------------------------------------------|
          | 0     | Emergency     | emerg     | System is unusable                         | A panic condition.                                       |
          | 1     | Alert         | alert     | Action must be taken immediately           | A condition that should be corrected immediately, such as a corrupted system database. |
          | 2     | Critical      | crit      | Critical conditions                        | Hard device errors.                                      |
          | 3     | Error         | err       | Error conditions                           |                                                          |
          | 4     | Warning       | warning   | Warning conditions                         |                                                          |
          | 5     | Notice        | notice    | Normal but significant conditions          | Conditions that are not error conditions, but that may require special handling. |
          | 6     | Informational | info      | Informational messages                     |                                                          |
          | 7     | Debug         | debug     | Debug-level messages                       | Messages that contain information normally of use only when debugging a program. |

      * **Header**
        * contains Timestamp, Hostname, Application name, Message ID
      * **Message**
        * could be simple readable text or only machine-readable
        * content of the message is not defined by the protocol only the format is
        * each message sent to the Syslog server has two labels associated with it:
          * The first label describes the function (facility) of the application that generated it
            * e.g., mail servers typically log using the mail facility
          * The second label specifies the severity level 
        * After these two labels, the action is specified
          * usually a filename in the `/var/log` directory tree, in which the messages will be stored

---

* **Windows Event Logs**
  * Windows Event logs or Event Logs are `.evtx` files in binary format stored locally in the Windows directory
    * Windows 2000 to WinXP/Windows Server 2003
      * `%WinDir%\system32\Config*.evt`
    * Windows Server 2008 to 2019, and Windows Vista to Win10:
      * `%WinDir%\system32\WinEVT\Logs*.evtx`
  * keep a detailed record of the vast majority of events that have occurred on the system
    * hardware events, user logins, program execution and installation, etc.
  * Categories of registered events include:
    * Application
      * Events logged by an application
        * Execution, Deployment error, etc.
    * System: Events logged by the Operating System
      * Device loading, startup errors, etc.
    * Security
      * Events that are relevant to the security of the system
        * Logins and logouts, file deletion, granting of administration permissions, etc.
    * Directory Service
      * a record available only to Domain Controllers, it stores Active Directory (AD) events
    * DNS Server
      * a record available only to DNS servers; logs of DNS service are stored
    * File Replication Service
      * a record available only for Domain Controllers, it stores Domain Controller Replication events
    * [Monitoring Windows Event Logs - A Tutorial (article)](https://www.manageengine.com/eu/network-monitoring/Eventlog_Tutorial_Part_I.html)

---

* **Windows Security Event Logs**
  * events stored by the system that contain information related to the “Windows Security audit policies”
    * Some of these elements are:
      * Account logon events
        * valid and invalid sign-ons and sign-offs
      * Account management
        * creation, modification, interaction and deletion of user accounts
      * Privilege use
      * Resource usage
        * file creation, modification, interaction and deletion
  * [Windows Security audit (article)](https://docs.nxlog.co/integrate/windows-security-audit.html)
  * [Windows Security Event Logs - cheatsheet](https://andreafortuna.org//2019/06/12/windows-security-event-logs-my-own-cheatsheet/)
  * [Windows Security Log Events - list](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/default.aspx)

---

* **Event Viewer**
  * program to view all different types of logs
* **Custom Views**
  * Event Viewer allows us to create custom search profiles, called “Custom Views”
  * use these to retrieve the event IDs we want from a system, removing all of the extra noise that we’re not interested in
  * can be useful if a system is not connected to a SIEM, allowing us to retrieve specific event logs